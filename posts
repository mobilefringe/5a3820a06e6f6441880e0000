<div class="content_container">
	<div class="blog_banner text-center position_rel" id="blog_banner_container">
		<!--<img src="//codecloud.cdn.speedyrails.net/sites/5a3820a06e6f6441880e0000/image/png/1515692811302/Screen Shot 2018-01-11 at 12.46.36 PM.png" class="" alt="">-->
		<script id = "blog_banner_template" type="x-tmpl-mustache">
			<img src="{{image_url}}"/>
			<div class="blog_banner_title">
			    <h1>  {{title}} <h1/>
			    <p>{{publish_date}}</p>
			</div>
		</script>
	</div>
	<div class="row blogs_container" >
		<div class="col-sm-8">
			<div class="blog_selector_bar">
				<span class="blog_selector">Popular</span>
				<span class="blog_selector active">Latest</span>
				<hr>
			</div>
			<div id="blog_container" >
				<script id = "blog_template" type="x-tmpl-mustache">
				    <div class="row blog_post hidden_now"  id="show_{{counter}}">
    				    <div class="col-sm-4">
    					    <img src="{{image_url}}"/>
    					</div>
    					
    					<div class="col-sm-8">
    					    <div>
    					       <span class="blog_tag" style="{{show_tag}}">{{main_tag}}</span>
    					       <h3>  {{title}} <h3/>
    					       <p class="blog_dates">{{publish_date}}</p>
    					       <p class="blog_short_desc"> {{description_short}}</p>
    					   </div>
    					</div>
    					<hr>
				    </div>
					
					
					   
				</script>
			</div>
			<!--<div id="popular_blog_container" class="hidden_now" >-->
			<!--	<script id = "popular_blog_template" type="x-tmpl/mustache">-->
			<!--		<div class="row">-->
   <!-- 				    <div class="col-sm-4">-->
   <!-- 					    <img src="{{image_url}}"/>-->
   <!-- 					</div>-->
    					
   <!-- 					<div class="col-sm-8">-->
   <!-- 					    <div>-->
   <!-- 					       <span class="blog_tag" style="{{show_tag}}">{{main_tag}}</span>-->
   <!-- 					       <h3>  {{title}} <h3/>-->
   <!-- 					       <p class="blog_dates">{{publish_date}}</p>-->
   <!-- 					       <p class="blog_short_desc"> {{description_short}}</p>-->
   <!-- 					   </div>-->
   <!-- 					</div>-->
			<!--	    </div>-->
			<!--		<hr>-->
			<!--	</script>-->
			<!--</div>-->
		</div>
		
		<div class="col-sm-4 newsletter_box">
		</div>
	</div>
	<div class="row">
        <div class="col-md-12">
            <input type="hidden" value="1" id="num_loaded" />
            <p class="hidden_now" id ="all_loaded">No More Posts</p>
            <p class="" id="loaded_posts">
                <a href="#" class="red" id="load_more_posts"><img src="//codecloud.cdn.speedyrails.net/sites/5808c7e76e6f6414b30c0000/image/png/1490624975000/down.png" class="load_more_arrow" alt=""><span class="post_details_link">Load More</span></a>
            </p>
        </div>
    </div>
</div>
<div class="row blog_newsletter_banner">
    <div class="blog_img" style="background-image: url('http://via.placeholder.com/1920x350/000000/ffffff?text=+');">
        <div class="subscribeBlog">
            <p class="caps">Your Weekly Dose of</p>
            <img src="//codecloud.cdn.speedyrails.net/sites/5a3820a06e6f6441880e0000/image/png/1515709428865/Screen Shot 2018-01-11 at 5.23.41 PM.png" class="" alt="">
        <form action=//mobilefringe.createsend.com/t/d/s/ykouu/ method="post" id="newsletterBlogForm">
            <label for="fieldEmail" style="display:none"></label>
            <input id="fieldEmail" name="cm-tkyhii-tkyhii" class="form-control" type="email" value="" placeholder="Enter your email address" required/> 
            <button class="contact_btn" data-i18n="general.submit">Sign Up</button>
            
            <span id="success_subscribe" class="hidden_now">Thank you for subscribing to our newsletter.</span>
        </form>
        </div>
        
    </div>
    
</div>


<script>
// var interval = 4;
// var totalPosts;
// var showingPosts;
$(document).ready(function() {
    function renderPageData(){
        var blog_posts = getBlogDataBySlug('cornwall-main').posts.sortBy(function(o){ return o.publish_date}).reverse();
        // console.log(blog_posts);
        //main banner post
        renderMainPost('#blog_banner_container','#blog_banner_template', blog_posts[0]);
        
        //three posts before subscription
        renderPosts();
        
        var posts = blog_posts.splice(1);
        // renderPosts('#posts_container', '#posts_template', posts);
        renderPosts('#blog_container','#blog_template', posts);
        
        var blog_popular_posts = blog_posts.sortBy(function(o){ return o.impression_count}).reverse();
        renderPosts('#popular_blog_container','#popular_blog_template', blog_popular_posts);
        
        show_content();
        load_more(1);
        
        
        $(".blog_selector").click(function(){
        var current_choice =$(this).text();
        console.log("clicked!", current_choice);
        
        $(".blog_selector").removeClass("active");
        $(this).addClass("active");
        
        if(current_choice == "Popular") {
            //sort by highest impression count
            $("#popular_blog_container").show();
            $("#blog_container").hide();
        }
        else {
            //sort by newest post
            $("#popular_blog_container").hide();
            $("#blog_container").show();
        }
    });
    $('#load_more_posts').click(function(e){
        var i = $('#num_loaded').val();
        load_more(i);
        e.preventDefault();
    });
    }
    
    loadMallData(renderPageData);
    
});



function renderMainPost(container, template, val){
    var item_list = [];
    var item_rendered = [];
    var template_html = $(template).html();
    var counter = 1;
    Mustache.parse(template_html);   // optional, speeds up future uses
    // $.each( val , function( key, val ) {
        if (val.image_url.indexOf('missing.png') > -1) {
            val.post_image = "//codecloud.cdn.speedyrails.net/sites/59c082786e6f6462ee1d0000/image/png/1507232968000/Group 10.png";
        } else {
            val.post_image = val.image_url;
        }
        
        if(val.body.length > 175){
            val.description_short = val.body.substring(0, 175) + "...";
        } else {
            val.description_short = val.body;
        }
        
        val.description_short = val.description_short.replace("&amp;", "&");
        
        var published_on = moment(val.publish_date).tz(getPropertyTimeZone());
        val.publish_date = published_on.format("MMM. DD");
        
        var rendered = Mustache.render(template_html,val);
        item_rendered.push(rendered);
        counter = counter + 1;
    // });
    $(container).html(item_rendered.join(''));
}

function renderPosts(container, template, collection){
    var item_list = [];
    var item_rendered = [];
    var template_html = $(template).html();
    var counter = 1;
    Mustache.parse(template_html);   // optional, speeds up future uses
    
    $.each( collection , function( key, val ) {
        if (val.image_url.indexOf('missing.png') > -1) {
            val.post_image = "//codecloud.cdn.speedyrails.net/sites/59c082786e6f6462ee1d0000/image/png/1507232968000/Group 10.png";
        } else {
            val.post_image = val.image_url;
        }
        
        if(val.body.length > 100){
            val.description_short = val.body.substring(0, 100) + "...";
        } else {
            val.description_short = val.body;
        }
        
        val.description_short = val.description_short.replace("&amp;", "&");
        
        var published_on = moment(val.publish_date).tz(getPropertyTimeZone());
        val.publish_date = published_on.format("MMM DD, YYYY");
        
        //get first tag 
        if(val.tag != null && val.tag !== undefined) {
            val.main_tag = val.tag[0];
            // console.log("main tag", val.main_tag);
            val.show_tag = "display:block";
        }
        else {
            val.show_tag = "display:none"
        }
        //get the tag that is capitalized
        // if(val.tag != null && val.tag !== undefined) {
        //     console.log(val.tag);
        //     $.each( val.tag , function( key, tag ) {
               
                
        //         if(tag[0] === tag[0].toUpperCase()){
        //             val.main_tag = tag;
        //         }
        //     })
        //     console.log("main tag", val.main_tag);
        // }
        
        val.counter = counter;
        
        var rendered = Mustache.render(template_html,val);
        item_rendered.push(rendered);
        counter = counter + 1;
        // item_list.push(val);
    });
    
    $(container).show();
    $(container).html(item_rendered.join(''));
}

function load_more(num){
    var n = parseInt(num);
    for(i = n; i < n + 3; i++){
        var id = i.toString();
        $('#show_' + id ).fadeIn();
    }
    var posts = getBlogDataBySlug('cornwall-main').posts;
    var total_posts = posts.length;
    if(i >= total_posts){
        $('#loaded_posts').hide();
        $('#all_loaded').show();
    }
    $('#num_loaded').val(i);
}
</script>
